<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado ENEM Pro - Completo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --text-main: #212529;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --bg-context: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #b0b0b0;
            --border-color: #333333;
            --bg-context: #2d2d2d;
        }

        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        .card { background-color: var(--bg-card); border-radius: 15px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); color: var(--text-main); }
        
        .option-btn { 
            text-align: left; margin-bottom: 12px; padding: 15px; border-radius: 10px; 
            transition: 0.3s; width: 100%; border: 1px solid var(--border-color); 
            background: var(--bg-card); color: var(--text-main); 
        }
        .option-btn:hover:not([disabled]) { background-color: rgba(13, 110, 253, 0.1); border-color: #0d6efd; }
        
        .correct { background-color: #198754 !important; border-color: #198754 !important; color: white !important; font-weight: bold; }
        .wrong { background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important; }
        
        #context-text { background-color: var(--bg-context); white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6; border: 1px solid var(--border-color); }
        .sticky-score { position: sticky; top: 10px; z-index: 100; }
        .theme-toggle { cursor: pointer; font-size: 1.2rem; border: none; background: none; }
        .progress { height: 8px; background-color: var(--border-color); }

        /* Zoom na imagem ao passar o mouse */
        .img-question { max-height: 450px; cursor: zoom-in; transition: transform 0.2s; }
        .img-question:active { transform: scale(1.5); z-index: 1000; position: relative; }
    </style>
</head>
<body class="py-4">
    <div class="container">
        <div class="row justify-content-center mb-4 sticky-score">
            <div class="col-md-9">
                <div class="card p-3 shadow">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                        <div class="d-flex align-items-center gap-2 flex-grow-1">
                            <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">üåô</button>
                            <select id="year-select" class="form-select w-auto" onchange="loadYear()"></select>
                            <select id="discipline-filter" class="form-select w-auto" onchange="filterAndReset()"></select>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary">‚úÖ <span id="score">0</span></span>
                            <span class="badge bg-danger">‚ùå <span id="error-count">0</span></span>
                            <span class="badge bg-secondary"><span id="current-pos">0</span>/<span id="total-filtered">0</span></span>
                            <button id="btn-review" class="btn btn-sm btn-outline-warning ms-1" onclick="toggleReviewMode()">üßê Erros</button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="clearProgress()">üßπ</button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;" id="progress-text">0% conclu√≠do</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-9">
                <div id="quiz-container" class="card p-4">
                    <div id="loading" class="text-center py-5">
                        <div class="spinner-border text-primary mb-2"></div>
                        <div>Carregando quest√µes do ENEM...</div>
                    </div>
                    
                    <div id="question-content" style="display:none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="q-discipline" class="badge bg-info text-dark"></span>
                            <span id="q-index" class="text-muted small"></span>
                        </div>
                        
                        <h4 id="q-title" class="mb-3"></h4>
                        
                        <div id="context-text" class="p-3 rounded mb-3"></div>
                        
                        <div id="question-image-container" class="text-center mb-3"></div>
                        
                        <p id="introduction" class="fw-bold"></p>
                        
                        <div id="options" class="d-grid"></div>
                        
                        <div id="feedback" class="mt-4 p-3 rounded alert text-center" style="display:none;"></div>
                        
                        <div class="d-flex gap-2 mt-4">
                            <button id="prev-btn" class="btn btn-outline-secondary flex-fill" onclick="changeQuestion(-1)">Anterior</button>
                            <button id="next-btn" class="btn btn-primary flex-fill" onclick="changeQuestion(1)">Pr√≥xima</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let answeredQuestions = [];
        let wrongQuestions = [];
        let isReviewMode = false;
        let currentYear = localStorage.getItem('enem_selected_year') || '2023';

        document.addEventListener('DOMContentLoaded', () => {
            const yearSelect = document.getElementById('year-select');
            for (let ano = 2023; ano >= 2009; ano--) {
                const opt = document.createElement('option');
                opt.value = ano;
                opt.innerText = `ENEM ${ano}`;
                if(ano == currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            
            const savedTheme = localStorage.getItem('enem_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

            loadYear();
        });

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('enem_theme', newTheme);
            document.getElementById('theme-icon').innerText = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function loadYear() {
            currentYear = document.getElementById('year-select').value;
            localStorage.setItem('enem_selected_year', currentYear);
            
            score = parseInt(localStorage.getItem(`enem_score_${currentYear}`)) || 0;
            answeredQuestions = JSON.parse(localStorage.getItem(`enem_answered_${currentYear}`)) || [];
            wrongQuestions = JSON.parse(localStorage.getItem(`enem_errors_${currentYear}`)) || [];
            currentIndex = parseInt(localStorage.getItem(`enem_last_index_${currentYear}`)) || 0;
            isReviewMode = false;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('question-content').style.display = 'none';

            fetch(`enem_${currentYear}.json`)
                .then(res => res.json())
                .then(data => {
                    allQuestions = data.sort((a, b) => (a.index || 0) - (b.index || 0));
                    updateDisciplineFilter();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('question-content').style.display = 'block';
                    filterAndReset(false);
                })
                .catch(() => {
                    document.getElementById('loading').innerHTML = `‚ùå Arquivo <b>enem_${currentYear}.json</b> n√£o encontrado.`;
                });
        }

        function updateDisciplineFilter() {
            const select = document.getElementById('discipline-filter');
            const disciplines = [...new Set(allQuestions.map(q => q.discipline))].filter(Boolean);
            select.innerHTML = '<option value="all">Todas as Mat√©rias</option>';
            disciplines.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.innerText = d.charAt(0).toUpperCase() + d.slice(1);
                select.appendChild(opt);
            });
        }

        function filterAndReset(resetIndex = true) {
            const filterVal = document.getElementById('discipline-filter').value;
            let temp = (filterVal === 'all') ? allQuestions : allQuestions.filter(q => q.discipline === filterVal);
            
            if (isReviewMode) {
                filteredQuestions = temp.filter(q => wrongQuestions.includes(q.index));
                if (filteredQuestions.length === 0) {
                    alert("Nenhum erro registrado aqui!");
                    isReviewMode = false;
                    filteredQuestions = temp;
                }
            } else {
                filteredQuestions = temp;
            }
            
            if(resetIndex) currentIndex = 0;
            if(currentIndex >= filteredQuestions.length) currentIndex = 0;
            
            updateUI();
            renderQuestion();
        }

        function updateUI() {
            document.getElementById('total-filtered').innerText = filteredQuestions.length;
            document.getElementById('score').innerText = score;
            document.getElementById('error-count').innerText = wrongQuestions.length;
            
            const btn = document.getElementById('btn-review');
            btn.className = isReviewMode ? 'btn btn-sm btn-warning ms-1' : 'btn btn-sm btn-outline-warning ms-1';
            btn.style.display = wrongQuestions.length > 0 ? 'inline-block' : 'none';

            const done = filteredQuestions.filter(q => answeredQuestions.includes(q.index)).length;
            const perc = filteredQuestions.length > 0 ? Math.round((done / filteredQuestions.length) * 100) : 0;
            document.getElementById('progress-bar').style.width = perc + '%';
            document.getElementById('progress-text').innerText = `${perc}% da mat√©ria conclu√≠da`;
        }

        function renderQuestion() {
            const q = filteredQuestions[currentIndex];
            if (!q) return;

            localStorage.setItem(`enem_last_index_${currentYear}`, currentIndex);
            document.getElementById('current-pos').innerText = currentIndex + 1;
            document.getElementById('q-discipline').innerText = (q.discipline || 'Geral').toUpperCase();
            document.getElementById('q-index').innerText = `Quest√£o #${q.index}`;
            document.getElementById('q-title').innerText = q.title || "";
            document.getElementById('context-text').innerText = q.context || "";
            document.getElementById('introduction').innerText = q.alternativesIntroduction || "";
            
            // Renderizar Imagem
            const imgCont = document.getElementById('question-image-container');
            imgCont.innerHTML = '';
            if (q.image) {
                const img = document.createElement('img');
                img.src = q.image;
                img.className = 'img-fluid rounded shadow-sm border img-question';
                img.title = "Clique e segure para ampliar";
                img.onerror = () => imgCont.innerHTML = '<small class="text-danger">‚ö†Ô∏è Imagem indispon√≠vel no servidor.</small>';
                imgCont.appendChild(img);
            }

            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            document.getElementById('feedback').style.display = 'none';

            q.alternatives.forEach(alt => {
                const btn = document.createElement('button');
                btn.className = 'btn option-btn';
                btn.innerHTML = `<strong>${alt.letter})</strong> ${alt.text}`;
                btn.onclick = () => checkAnswer(alt.letter, btn);
                optionsDiv.appendChild(btn);
            });

            document.getElementById('prev-btn').disabled = (currentIndex === 0);
            document.getElementById('next-btn').disabled = (currentIndex === filteredQuestions.length - 1);
        }

        function checkAnswer(letter, clickedBtn) {
            const q = filteredQuestions[currentIndex];
            const correct = q.correctAlternative;
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
                if (btn.innerText.trim().startsWith(correct + ")")) btn.classList.add('correct');
            });

            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';

            if (letter === correct) {
                wrongQuestions = wrongQuestions.filter(id => id !== q.index);
                if (!answeredQuestions.includes(q.index)) {
                    score++;
                    answeredQuestions.push(q.index);
                }
                feedback.className = 'mt-4 p-3 rounded alert alert-success';
                feedback.innerHTML = "‚ú® <b>Correto!</b>";
            } else {
                if (!wrongQuestions.includes(q.index)) wrongQuestions.push(q.index);
                clickedBtn.classList.add('wrong');
                feedback.className = 'mt-4 p-3 rounded alert alert-danger';
                feedback.innerHTML = `‚ùå <b>Incorreto.</b> A correta √© <b>${correct}</b>`;
            }

            localStorage.setItem(`enem_score_${currentYear}`, score);
            localStorage.setItem(`enem_answered_${currentYear}`, JSON.stringify(answeredQuestions));
            localStorage.setItem(`enem_errors_${currentYear}`, JSON.stringify(wrongQuestions));
            updateUI();
        }

        function changeQuestion(step) {
            currentIndex += step;
            renderQuestion();
        }

        function toggleReviewMode() {
            isReviewMode = !isReviewMode;
            filterAndReset(true);
        }

        function clearProgress() {
            if(confirm("Zerar progresso deste ano?")) {
                localStorage.removeItem(`enem_score_${currentYear}`);
                localStorage.removeItem(`enem_answered_${currentYear}`);
                localStorage.removeItem(`enem_errors_${currentYear}`);
                localStorage.removeItem(`enem_last_index_${currentYear}`);
                location.reload();
            }
        }
    </script>
</body>
</html>
