<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado ENEM 2023</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .option-btn { text-align: left; margin-bottom: 12px; padding: 15px; border-radius: 10px; transition: 0.3s; width: 100%; border: 1px solid #dee2e6; background: white; }
        .option-btn:hover:not([disabled]) { background-color: #e9ecef; border-color: #0d6efd; }
        .correct { background-color: #d1e7dd !important; border-color: #0f5132 !important; color: #0f5132; font-weight: bold; }
        .wrong { background-color: #f8d7da !important; border-color: #842029 !important; color: #842029; }
        #context-text { white-space: pre-wrap; font-size: 0.95rem; line-height: 1.6; }
        .sticky-score { position: sticky; top: 10px; z-index: 100; }
    </style>
</head>
<body class="py-4">
    <div class="container">
        <div class="row justify-content-center mb-4 sticky-score">
            <div class="col-md-8">
                <div class="card p-3 d-flex flex-row justify-content-between align-items-center">
                    <div class="flex-grow-1 me-3">
                        <select id="discipline-filter" class="form-select" onchange="filterAndReset()">
                            <option value="all">Todas as Mat√©rias</option>
                        </select>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">Acertos: <span id="score">0</span></span>
                        <span class="badge bg-secondary">Quest√£o: <span id="current-pos">0</span>/<span id="total-filtered">0</span></span>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearProgress()" title="Zerar Progresso">üßπ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-8">
                <div id="quiz-container" class="card p-4">
                    <div id="loading" class="text-center">Carregando base de dados...</div>
                    <div id="question-content" style="display:none;">
                        <div class="d-flex justify-content-between">
                            <span id="q-discipline" class="badge bg-info text-dark mb-2"></span>
                            <span id="q-index" class="text-muted small"></span>
                        </div>
                        <h4 id="q-title" class="mb-3"></h4>
                        <div id="context-text" class="p-3 bg-white border border-light rounded mb-3"></div>
                        <p id="introduction" class="fw-bold text-dark"></p>
                        <div id="options" class="d-grid"></div>
                        <div id="feedback" class="mt-4 p-3 rounded alert" style="display:none;"></div>
                        <div class="d-flex gap-2 mt-4">
                            <button id="prev-btn" class="btn btn-outline-secondary flex-fill" onclick="changeQuestion(-1)">‚¨ÖÔ∏è Anterior</button>
                            <button id="next-btn" class="btn btn-primary flex-fill" onclick="changeQuestion(1)">Pr√≥xima ‚û°Ô∏è</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let filteredQuestions = [];
        let currentIndex = parseInt(localStorage.getItem('enem_last_index')) || 0;
        let score = parseInt(localStorage.getItem('enem_score')) || 0;
        let answeredQuestions = JSON.parse(localStorage.getItem('enem_answered')) || [];

        fetch('enem_2023_final.json')
            .then(response => response.json())
            .then(data => {
                allQuestions = data.sort((a, b) => (a.index || 0) - (b.index || 0));
                const disciplines = [...new Set(allQuestions.map(q => q.discipline))];
                const select = document.getElementById('discipline-filter');
                disciplines.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.innerText = d.charAt(0).toUpperCase() + d.slice(1);
                    select.appendChild(opt);
                });

                // Recuperar filtro salvo
                const savedFilter = localStorage.getItem('enem_filter') || 'all';
                select.value = savedFilter;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('question-content').style.display = 'block';
                filterAndReset(false); // false para n√£o zerar o index ao carregar
            });

        function filterAndReset(resetIndex = true) {
            const filterVal = document.getElementById('discipline-filter').value;
            localStorage.setItem('enem_filter', filterVal);
            
            filteredQuestions = (filterVal === 'all') ? allQuestions : allQuestions.filter(q => q.discipline === filterVal);
            
            if(resetIndex) currentIndex = 0;
            if(currentIndex >= filteredQuestions.length) currentIndex = 0;

            document.getElementById('total-filtered').innerText = filteredQuestions.length;
            document.getElementById('score').innerText = score;
            renderQuestion();
        }

        function renderQuestion() {
            const q = filteredQuestions[currentIndex];
            if (!q) return;

            localStorage.setItem('enem_last_index', currentIndex);
            document.getElementById('current-pos').innerText = currentIndex + 1;
            document.getElementById('q-discipline').innerText = q.discipline.toUpperCase();
            document.getElementById('q-index').innerText = `ENEM 2023 | Item #${q.index}`;
            document.getElementById('q-title').innerText = q.title;
            document.getElementById('context-text').innerText = q.context || "";
            document.getElementById('introduction').innerText = q.alternativesIntroduction;
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = '';
            document.getElementById('feedback').style.display = 'none';

            q.alternatives.forEach(alt => {
                const btn = document.createElement('button');
                btn.className = 'btn option-btn';
                btn.innerHTML = `<strong>${alt.letter})</strong> ${alt.text}`;
                btn.onclick = () => checkAnswer(alt.letter, btn);
                optionsDiv.appendChild(btn);
            });

            document.getElementById('prev-btn').disabled = (currentIndex === 0);
            document.getElementById('next-btn').disabled = (currentIndex === filteredQuestions.length - 1);
        }

        function checkAnswer(letter, clickedBtn) {
            const q = filteredQuestions[currentIndex];
            const correct = q.correctAlternative;
            const buttons = document.querySelectorAll('.option-btn');

            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.innerText.trim().startsWith(correct + ")")) btn.classList.add('correct');
            });

            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';

            if (letter === correct) {
                if (!answeredQuestions.includes(q.index)) {
                    score++;
                    answeredQuestions.push(q.index);
                    localStorage.setItem('enem_score', score);
                    localStorage.setItem('enem_answered', JSON.stringify(answeredQuestions));
                }
                feedback.className = 'mt-4 p-3 rounded alert alert-success';
                feedback.innerHTML = "‚úÖ <strong>Correto!</strong>";
            } else {
                clickedBtn.classList.add('wrong');
                feedback.className = 'mt-4 p-3 rounded alert alert-danger';
                feedback.innerHTML = `‚ùå <strong>Incorreto.</strong> A resposta era <strong>${correct}</strong>.`;
            }
            document.getElementById('score').innerText = score;
        }

        function changeQuestion(step) {
            currentIndex += step;
            renderQuestion();
        }

        function clearProgress() {
            if(confirm("Deseja zerar seu placar e progresso?")) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
